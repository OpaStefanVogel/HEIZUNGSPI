<!DOCTYPE html>
<html><head><meta charset="utf-8"/><title>Heizung</title></head>

<style>
button {font-size:130%}
  </style>

<body onload="">

<script id="scr" type="application/ecmascript">
var websocket=0;
var wgesamt="";
var CodeArray=[];
function websocket_verbinden() {
  if (websocket!=0) websocket.close();
  var Adresse=document.getElementById("Websocket_Adresse").value;
  websocket = new WebSocket(Adresse,"fiktiv");
  websocket.onmessage = function(event) {
    var w;
    w=event.data;
    //alert(w+"####");
    var textarea=document.getElementById("Websocket-Antwort");
    textarea.value+=w; //firstChild.nodeValue+=w;
    textarea.scrollTop = textarea.scrollHeight;
    if ((w.slice(-2)=="> ")||(w.slice(-4)=="gap>")) {
      if (noch_nicht_gesendet>0) {
        //alert(noch_nicht_gesendet);
        //alert(CodeArray[CodeArray.length-noch_nicht_gesendet]);
        textarea.value+=CodeArray[CodeArray.length-noch_nicht_gesendet]+"\n";
        textarea.scrollTop = textarea.scrollHeight;
        document.getElementById("noch_zu_rechnen").firstChild.nodeValue="Noch zu rechnen "+noch_nicht_gesendet+" Zeilen, bisher "+textarea.value.length+" Zeichen empfangen.";
        websocket.send(CodeArray[CodeArray.length-noch_nicht_gesendet]);
        noch_nicht_gesendet=noch_nicht_gesendet-1;
        } else {
          document.getElementById("noch_zu_rechnen").firstChild.nodeValue="Fertig.";
          }          
      } else {
        document.getElementById("noch_zu_rechnen").firstChild.nodeValue="Noch zu rechnen "+noch_nicht_gesendet+" Zeilen, bisher "+textarea.value.length+" Zeichen empfangen.";
        }
    };
  websocket.onopen = function() {
    websocket.send('disconnect');
    //restart_GAP();
    //alert("open");
    }; 
  websocket.onclose = function() {
    //alert(77);
    //websocket.send("close");
    };
  }
function websocket_verbunden() {
  if (websocket!=0) {
    document.getElementById("Websocket_Status").firstChild.nodeValue=(["CONNECTING","OPEN","CLOSING","CLOSED"])[websocket.readyState];
    }
  }
setInterval(websocket_verbunden,1000);

var noch_nicht_gesendet=0;
var CodeArray=[];
function ueber_websocket_ausrechnen(event) {
  markiere_Button(event,zuletzt_GAP_angeklickt);
  CodeArray=document.getElementById("Ausgabe").lastChild.nodeValue.split("\n");
  //alert(CodeArray);
  var textarea=document.getElementById("Websocket-Antwort");
  textarea.value="gap> "+CodeArray[0]+"\n";PLOT1=0;PLOT2=0;
  textarea.scrollTop = textarea.scrollHeight;
  noch_nicht_gesendet=CodeArray.length-1;
  document.getElementById("noch_zu_rechnen").firstChild.nodeValue="Noch zu rechnen "+noch_nicht_gesendet+" Zeilen.";
  websocket.send(CodeArray[0]);
  }

function ueber_websocket_testen(event,Testinput) {
  //markiere_Button(event,zuletzt_GAP_angeklickt);
  CodeArray=document.getElementById(Testinput).value.split("\n");
  //alert(CodeArray);
  var textarea=document.getElementById("Websocket-Antwort");
  textarea.value+=CodeArray[0]+"\n";//PLOT1=0;PLOT2=0;
  textarea.scrollTop = textarea.scrollHeight;
  noch_nicht_gesendet=CodeArray.length-1;
  document.getElementById("noch_zu_rechnen").firstChild.nodeValue="Noch zu rechnen: "+noch_nicht_gesendet+" Zeilen";
  websocket.send(CodeArray[0]);
  }

function restart_GAP(event) {
  markiere_Button(event,zuletzt_GAP_angeklickt);
  noch_nicht_gesendet=0;
  document.getElementById("Websocket-Antwort").value="";
  document.getElementById("Beweglichkeit").firstChild.nodeValue="";
  document.getElementById("Einsetzkanten").firstChild.nodeValue="";
  document.getElementById("noch_zu_rechnen").firstChild.nodeValue="GAP wird neu gestartet, dauert etwas...(bis 20 Sek.)";
  websocket.send("QUIT;");
  }

function Websocket_Display_aus_ein() {
  var Display=document.getElementById("Websocket_Display");
  if (Display.getAttribute("style")!=undefined) {
    Display.removeAttribute("style");
    var textarea=document.getElementById("Websocket-Antwort")
    //textarea.value+="";
    textarea.scrollTop = textarea.scrollHeight;
    } else {
      Display.setAttribute("style","display:none");
      }
  }

function Uhrzeit_aktualisieren() {
  websocket.send('Exec("date; sudo date -s @'+(Date.now()/1000)+'");');
  }

</script>

<div id="Websocket_Rahmen"><div style="outline:solid; outline-size: 5px; outline-color: beige;">
<div>zu <input id="Websocket_Adresse" size="25" value="ws://modellbahnpult:1880/ws/gatttool"/> <button onclick="websocket_verbinden()">Verbindung herstellen</button> <a href="http://www.w3.org/TR/2012/CR-websockets-20120920/#the-websocket-interface" id="Websocket_Status">CLOSED</a> (falls nötig <button onclick="restart_GAP(event)">Restart GAP</button>)</div>
<div><button onclick="Websocket_Display_aus_ein()" style="vertical-align:top">Display aus/ein ("aus" rechnet schneller)</button> <span id="noch_zu_rechnen"> </span> 
<span id="Beweglichkeit" style="color: darkred; font-style: bold;"> </span>
<span id="Einsetzkanten" style="color: yellowgreen; font-style: bold;"> </span></div>
<div><span id="Websocket_Display"><textarea id="Websocket-Antwort" cols="80" rows="15" style="font-size:100%; white-space:pre; background-color:Aliceblue" readonly="readonly"></textarea></span></div>
<div>1. <button onclick='Script_heraussuchen(event,"Anfangsprogramm")'>Programmcode heraussuchen</button> und dann <button onclick="ueber_websocket_ausrechnen(event)">über websocket compilieren</button> (einmal im laufenden GAP reicht)</div>
<div>2. <button onclick='Script_heraussuchen(event,"aktuellesProgrammstück")'>aktuell zu testendes Programmstück heraussuchen</button> und extra <button onclick="ueber_websocket_ausrechnen(event)">über websocket compilieren</button></div>
<div><span style="vertical-align:top">3. Zusatztesteingabe:</span> <textarea id="Testinput1" cols="60" rows="5" style="font-size:100%; white-space:pre;">connect
</textarea><button onclick="ueber_websocket_testen(event,'Testinput1')" style="vertical-align:bottom">über websocket testen</button></div>
<div>4. <button onclick="Uhrzeit_aktualisieren()">Uhrzeit aktualisieren</button></div>

<!--div><i>Schließlich der zu kopierende und auszuführende Programmcode, wenn nicht über Websocket gerechnet wird:</i></div-->

<div id="AusgabeSVG" style="white-space:wrap;"></div>
<div id="Ausgabe" style="white-space:pre-wrap; font-family:Courier,monospace; font-size:70%; color:black;"><!--div> <a id="download"> </a><small> (dieser Download erfolgt mit <a href="http://stackoverflow.com/questions/2897619/using-html5-javascript-to-generate-and-save-a-file">&lt;a href=... download=...&gt;</a>)</small></div-->
  </div>
  </body>
  </html>
